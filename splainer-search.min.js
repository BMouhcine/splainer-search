"use strict";Function.prototype.bind||(Function.prototype.bind=function(oThis){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,FNOP=function(){},fBound=function(){return fToBind.apply(this instanceof FNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};return FNOP.prototype=this.prototype,fBound.prototype=new FNOP,fBound}),angular.module("o19s.splainer-search").service("explainSvc",function(vectorSvc){var meOrOnlyChild=function(explain){var infl=explain.influencers();return 1===infl.length?infl[0]:explain},tieRegex=/max plus ([0-9.]+) times/,createExplain=function(explJson){var base=new Explain(explJson),description=explJson.description,details=[];explJson.hasOwnProperty("details")&&(details=explJson.details);var tieMatch=description.match(tieRegex);if(description.startsWith("MatchAllDocsQuery"))return console.log("Match all docs query"),MatchAllDocsExplain.prototype=base,new MatchAllDocsExplain(explJson);if(description.startsWith("weight("))return WeightExplain.prototype=base,console.log("weight"),new WeightExplain(explJson);if(description.startsWith("FunctionQuery"))return console.log("func query"),FunctionQueryExplain.prototype=base,new FunctionQueryExplain(explJson);if(tieMatch&&tieMatch.length>1){console.log("dismax tie expl");var tie=parseFloat(tieMatch[1]);return DismaxTieExplain.prototype=base,new DismaxTieExplain(explJson,tie)}if(description.hasSubstr("max of"))return console.log("dismax expl"),DismaxExplain.prototype=base,meOrOnlyChild(new DismaxExplain(explJson));if(description.hasSubstr("sum of"))return SumExplain.prototype=base,console.log("sum or product expl"),meOrOnlyChild(new SumExplain(explJson));if(description.hasSubstr("product of")){var coordExpl=null;return 2===details.length&&angular.forEach(details,function(detail){detail.description.startsWith("coord(")&&(CoordExplain.prototype=base,coordExpl=new CoordExplain(explJson,parseFloat(detail.value)))}),console.log("product expl"),null!==coordExpl?coordExpl:(ProductExplain.prototype=base,meOrOnlyChild(new ProductExplain(explJson)))}return console.log("regular explain"),base},Explain=function(explJson){var datExplain=this;this.asJson=explJson,this.realContribution=this.score=parseFloat(explJson.value),this.realExplanation=this.description=explJson.description;var details=[];explJson.hasOwnProperty("details")&&(details=explJson.details),this.children=[],angular.forEach(details,function(detail){datExplain.children.push(createExplain(detail))}),this.influencers=function(){return[]},this.contribution=function(){return this.realContribution},this.explanation=function(){return this.realExplanation},this.vectorize=function(){var rVal=vectorSvc.create();return rVal.set(this.explanation(),this.contribution()),rVal},this.toStr=function(depth){void 0===depth&&(depth=0);var prefix=new Array(2*depth).join(" "),me=prefix+this.contribution()+" "+this.explanation()+"\n",childStrs=[];return angular.forEach(this.influencers(),function(child){childStrs.push(child.toStr(depth+1))}),me+childStrs.join("\n")},this.rawStr=function(){return JSON.stringify(this.asJson)}},MatchAllDocsExplain=function(){this.realExplanation="You queried *:* (all docs returned w/ score of 1)"},WeightExplain=function(explJson){var weightRegex=/weight\((.*?)\s+in\s+\d+?\)/,description=explJson.description,match=description.match(weightRegex);this.realExplanation=null!==match&&match.length>1?match[1]:description},FunctionQueryExplain=function(explJson){var funcQueryRegex=/FunctionQuery\((.*)\)/,description=explJson.description,match=description.match(funcQueryRegex);this.realExplanation=null!==match&&match.length>1?match[1]:description},CoordExplain=function(explJson,coordFactor){1>coordFactor&&(this.realExplanation="Matches Punished by "+coordFactor+" (not all query terms matched)",this.influencers=function(){for(var infl=[],i=0;i<this.children.length;i++)this.children[i].description.hasSubstr("coord")||infl.push(this.children[i]);return infl},this.vectorize=function(){var rVal=vectorSvc.create();return angular.forEach(this.influencers(),function(infl){rVal=vectorSvc.add(rVal,infl.vectorize())}),rVal=vectorSvc.scale(rVal,coordFactor)})},DismaxTieExplain=function(explJson,tie){this.realExplanation="Dismax (max plus:"+tie+" times others",this.influencers=function(){var infl=angular.copy(this.children);return infl.sort(function(a,b){return b.score-a.score}),infl},this.vectorize=function(){var infl=this.influencers(),rVal=infl[0].vectorize();return angular.forEach(infl.slice(1),function(currInfl){var vInfl=currInfl.vectorize(),vInflScaled=vectorSvc.scale(vInfl,tie);rVal=vectorSvc.add(rVal,vInflScaled)}),rVal}},DismaxExplain=function(){this.realExplanation="Dismax (take winner of below)",this.influencers=function(){var infl=angular.copy(this.children);return infl.sort(function(a,b){return b.score-a.score}),infl},this.vectorize=function(){var infl=this.influencers();return infl[0].vectorize()}},SumExplain=function(){this.realExplanation="Sum of the following:",this.isSumExplain=!0,this.influencers=function(){var preInfl=angular.copy(this.children);preInfl.sort(function(a,b){return b.score-a.score});var infl=[];return angular.forEach(preInfl,function(child){child.hasOwnProperty("isSumExplain")&&child.isSumExplain?angular.forEach(child.influencers(),function(grandchild){infl.push(grandchild)}):infl.push(child)}),infl},this.vectorize=function(){var rVal=vectorSvc.create();return angular.forEach(this.influencers(),function(infl){rVal=vectorSvc.add(rVal,infl.vectorize())}),rVal}},ProductExplain=function(){this.realExplanation="Product of following:";var oneFilled=function(length){return Array.apply(null,new Array(length)).map(Number.prototype.valueOf,1)};this.influencers=function(){var infl=angular.copy(this.children);return infl.sort(function(a,b){return b.score-a.score}),infl},this.vectorize=function(){for(var rVal=vectorSvc.create(),infl=this.influencers(),inflFactors=oneFilled(infl.length),factorInfl=0;factorInfl<infl.length;factorInfl++)for(var currMult=0;currMult<infl.length;currMult++)currMult!==factorInfl&&(inflFactors[factorInfl]=inflFactors[factorInfl]*infl[currMult].contribution());for(var currInfl=0;currInfl<infl.length;currInfl++){var i=infl[currInfl],thisVec=i.vectorize(),thisScaledByOthers=vectorSvc.scale(thisVec,inflFactors[currInfl]);rVal=vectorSvc.add(rVal,thisScaledByOthers)}return rVal}};this.createExplain=function(explJson){return createExplain(explJson)}}),angular.module("o19s.splainer-search").service("fieldSpecSvc",function(){var addFieldOfType=function(fieldSpec,fieldType,fieldName){"sub"===fieldType?(fieldSpec.hasOwnProperty("subs")||(fieldSpec.subs=[]),fieldSpec.subs.push(fieldName)):fieldSpec.hasOwnProperty(fieldType)||(fieldSpec[fieldType]=fieldName),fieldSpec.fields.push(fieldName)},populateFieldSpec=function(fieldSpec,fieldSpecStr){var fieldSpecs=fieldSpecStr.split(/[\s,]+/);angular.forEach(fieldSpecs,function(aField){var typeAndField=aField.split(":"),fieldType=null,fieldName=null;2===typeAndField.length?(fieldType=typeAndField[0],fieldName=typeAndField[1]):1===typeAndField.length&&(fieldName=typeAndField[0],fieldType=fieldSpec.hasOwnProperty("title")?"sub":"title"),fieldType&&fieldName&&addFieldOfType(fieldSpec,fieldType,fieldName)})},FieldSpec=function(fieldSpecStr){this.fields=[],this.fieldSpecStr=fieldSpecStr,populateFieldSpec(this,fieldSpecStr),this.hasOwnProperty("id")||(this.id="id",this.fields.push("id")),this.hasOwnProperty("title")||(this.title=this.id),this.fieldList=function(){var rVal=[this.id];return this.forEachField(function(fieldName){rVal.push(fieldName)}),rVal},this.forEachField=function(innerBody){this.hasOwnProperty("title")&&innerBody(this.title),this.hasOwnProperty("thumb")&&innerBody(this.thumb),angular.forEach(this.subs,function(sub){innerBody(sub)})}};this.createFieldSpec=function(fieldSpecStr){return new FieldSpec(fieldSpecStr)}}),angular.module("o19s.splainer-search").service("normalDocsSvc",function(explainSvc){var assignSingleField=function(queryDoc,solrDoc,solrField,toProperty){solrDoc.hasOwnProperty(solrField)&&(queryDoc[toProperty]=solrDoc[solrField].slice(0,200))},assignFields=function(queryDoc,solrDoc,fieldSpec){assignSingleField(queryDoc,solrDoc,fieldSpec.id,"id"),assignSingleField(queryDoc,solrDoc,fieldSpec.title,"title"),assignSingleField(queryDoc,solrDoc,fieldSpec.thumb,"thumb"),queryDoc.subs={},angular.forEach(fieldSpec.subs,function(subFieldName){solrDoc.hasOwnProperty(subFieldName)&&(queryDoc.subs[subFieldName]=solrDoc[subFieldName])})},NormalDoc=function(fieldSpec,doc){this.solrDoc=doc,assignFields(this,doc,fieldSpec);var hasThumb=!1;this.hasOwnProperty("thumb")&&(hasThumb=!0),this.subsList=[];var that=this;angular.forEach(this.subs,function(subValue,subField){"string"==typeof subValue&&(subValue=subValue.slice(0,200));var expanded={field:subField,value:subValue};that.subsList.push(expanded)}),this.hasThumb=function(){return hasThumb},this.url=function(){return this.solrDoc.url(fieldSpec.id,this.id)};var explainJson=this.solrDoc.explain(this.id),simplerExplain=explainSvc.createExplain(explainJson),explSummary=simplerExplain.toStr(),hotMatches=simplerExplain.vectorize().toStr();this.explain=function(){return simplerExplain},this.explainSummary=function(){return explSummary},this.hotMatches=function(){return hotMatches},this.score=simplerExplain.contribution()};this.createNormalDoc=function(fieldSpec,doc){return new NormalDoc(fieldSpec,doc)},this.createPlaceholderDoc=function(docId,stubTitle){return{id:docId,title:stubTitle}}}),function(){var Promise=function(taskFn,taskThis,taskArgs){this.completed=!1,this.$$myFn=taskFn,this.then=function(nextTaskFn,nextTaskThisOrArgs,nextTaskArgs){return nextTaskThisOrArgs instanceof Array&&(nextTaskArgs=nextTaskThisOrArgs,nextTaskThisOrArgs=void 0),this.next=new Promise(nextTaskFn,nextTaskThisOrArgs,nextTaskArgs),this.completed&&this.completer(),this.next},this.apply=function(){taskFn.promise=this,taskFn.apply(taskThis,taskArgs)},this.completer=function(){this.completed=!0,this.next&&(this.next.apply(),this.completed=!1)},this.complete=this.completer.bind(this)};Promise.create=function(func){if(func.hasOwnProperty("promise"))return func.promise;var firstPromise=new Promise;return firstPromise},window.Promise=Promise}(),angular.module("o19s.splainer-search").service("solrSearchSvc",function($http){var activeQueries=0,buildUrl=function(url,urlArgs){var baseUrl=url+"?";return angular.forEach(urlArgs,function(values,param){angular.forEach(values,function(value){baseUrl+=param+"="+value+"&"})}),baseUrl=baseUrl.replace(/%/g,"%25"),baseUrl.slice(0,-1)},searchSvc=this,buildTokensUrl=function(fieldList,solrUrl,idField,docId){var escId=encodeURIComponent(searchSvc.escapeUserQuery(docId)),tokensArgs={indent:["true"],wt:["xml"],facet:["true"],"facet.field":[],"facet.mincount":["1"]};return angular.forEach(fieldList,function(fieldName){"score"!==fieldName&&tokensArgs["facet.field"].push(fieldName)}),buildUrl(solrUrl,tokensArgs)+"&q="+idField+":"+escId},buildSolrUrl=function(fieldList,solrUrl,solrArgs,queryText){solrArgs.fl=[fieldList.join(" ")],solrArgs.wt=["json"],solrArgs.debug=["true"],solrArgs["debug.explain.structured"]=["true"];var baseUrl=buildUrl(solrUrl,solrArgs);return baseUrl=baseUrl.replace(/#\$query##/g,encodeURIComponent(queryText))},SolrSearcher=function(fieldList,solrUrl,solrArgs,queryText){this.callUrl=this.linkUrl="",this.callUrl=buildSolrUrl(fieldList,solrUrl,solrArgs,queryText),this.linkUrl=this.callUrl.replace("wt=json","wt=xml"),this.linkUrl=this.linkUrl+"&indent=true&echoParams=all",this.docs=[],this.numFound=0,this.inError=!1,this.search=function(){var url=this.callUrl+"&json.wrf=JSON_CALLBACK";this.inError=!1;var promise=Promise.create(this.search),that=this,getExplData=function(data){if(data.hasOwnProperty("debug")){var dbg=data.debug;if(dbg.hasOwnProperty("explain"))return dbg.explain}return{}};return activeQueries++,$http.jsonp(url).success(function(data){activeQueries--,that.numFound=data.response.numFound;var explDict=getExplData(data);angular.forEach(data.response.docs,function(solrDoc){solrDoc.url=function(idField,docId){return buildTokensUrl(fieldList,solrUrl,idField,docId)},solrDoc.explain=function(docId){return explDict.hasOwnProperty(docId)?explDict[docId]:""},that.docs.push(solrDoc)}),promise.complete()}).error(function(){activeQueries--,that.inError=!0,promise.complete()}),promise}};this.createSearcherFromSettings=function(settings,queryText){return new SolrSearcher(settings.createFieldSpec().fieldList(),settings.solrUrl,settings.selectedTry.solrArgs,queryText)},this.createSearcher=function(fieldList,solrUrl,solrArgs,queryText){return new SolrSearcher(fieldList,solrUrl,solrArgs,queryText)},this.activeQueries=function(){return activeQueries},this.escapeUserQuery=function(queryText){var escapeChars=["+","-","&","!","(",")","[","]","{","}","^",'"',"~","*","?",":","\\"],regexp=new RegExp("(\\"+escapeChars.join("|\\")+")","g");return queryText.replace(regexp,"\\$1")},this.parseSolrArgs=function(argsStr){var splitUp=argsStr.split("?");2===splitUp.length&&(argsStr=splitUp[1]);var vars=argsStr.split("&"),rVal={};return angular.forEach(vars,function(qVar){var nameAndValue=qVar.split("=");if(2===nameAndValue.length){var name=nameAndValue[0],value=nameAndValue[1],decodedValue=decodeURIComponent(value);rVal.hasOwnProperty(name)?rVal[name].push(decodedValue):rVal[name]=[decodedValue]}}),rVal},this.formatSolrArgs=function(argsObj){var rVal="";return angular.forEach(argsObj,function(values,param){angular.forEach(values,function(value){rVal+=param+"="+value+"&"})}),rVal=rVal.replace(/%/g,"%25"),rVal.slice(0,-1)},this.parseSolrPath=function(pathStr){pathStr.startsWith("/")&&(pathStr=pathStr.slice(1));var solrPrefix="solr/";if(pathStr.startsWith(solrPrefix)){pathStr=pathStr.slice(solrPrefix.length);var colAndHandler=pathStr.split("/");if(2===colAndHandler.length){var collectionName=colAndHandler[0],requestHandler=colAndHandler[1];return requestHandler.endsWith("/")&&(requestHandler=requestHandler.slice(0,requestHandler.length-1)),{collectionName:collectionName,requestHandler:requestHandler}}}return null},this.parseSolrUrl=function(solrReq){var parseUrl=function(url){var a=document.createElement("a");return a.href=url,a},parsedUrl=parseUrl(solrReq);parsedUrl.solrArgs=this.parseSolrArgs(parsedUrl.search);var pathParsed=this.parseSolrPath(parsedUrl.pathname);if(!pathParsed)return null;parsedUrl.collectionName=pathParsed.collectionName,parsedUrl.requestHandler=pathParsed.requestHandler;var solrEndpoint=function(){return parsedUrl.protocol+"//"+parsedUrl.host+parsedUrl.pathname};return parsedUrl.solrEndpoint=solrEndpoint,parsedUrl}}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(str){return 0===this.indexOf(str)}),"function"!=typeof String.prototype.hasSubstr&&(String.prototype.hasSubstr=function(str){return-1!==this.indexOf(str)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(suffix){return-1!==this.indexOf(suffix,this.length-suffix.length)}),angular.module("o19s.splainer-search").service("vectorSvc",function(){var SparseVector=function(){this.vecObj={},this.set=function(key,value){this.vecObj[key]=value},this.get=function(key){return this.vecObj.hasOwnProperty(key)?this.vecObj[key]:void 0},this.toStr=function(){var rVal="",sortedL=[];return angular.forEach(this.vecObj,function(value,key){sortedL.push([key,value])}),sortedL.sort(function(lhs,rhs){return rhs[1]-lhs[1]}),angular.forEach(sortedL,function(keyVal){rVal+=keyVal[1]+" "+keyVal[0]+"\n"}),rVal}};this.create=function(){return new SparseVector},this.add=function(lhs,rhs){var rVal=this.create();return angular.forEach(lhs.vecObj,function(value,key){rVal.set(key,value)}),angular.forEach(rhs.vecObj,function(value,key){rVal.set(key,value)}),rVal},this.scale=function(lhs,scalar){var rVal=this.create();return angular.forEach(lhs.vecObj,function(value,key){rVal.set(key,value*scalar)}),rVal}});